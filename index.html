<!DOCTYPE html>
<html>
<head>
    <title>Monopoly</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #667eea; min-height: 100vh; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 20px; max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; }
        
        button { padding: 12px 24px; font-size: 16px; margin: 10px 5px; cursor: pointer; border: none; border-radius: 8px; background: #667eea; color: white; }
        button:hover { background: #5568d3; }
        
        #start { text-align: center; padding: 40px; }
        #playerSetup { display: none; padding: 20px; }
        #game { display: none; }
        
        .setup-container { max-width: 600px; margin: 0 auto; }
        .player-input { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .player-input input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .color-picker { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .color-option { width: 50px; height: 50px; border-radius: 4px; cursor: pointer; border: 3px solid transparent; }
        .color-option.selected { border-color: #000; }
        
        .game-layout { display: flex; gap: 20px; }
        .game-board { flex: 1; }
        .players-panel { width: 300px; background: #f9f9f9; padding: 20px; border-radius: 8px; border: 2px solid #ddd; }
        
        canvas { border: 3px solid #333; background: #2d5016; display: block; }
        #message { font-size: 16px; color: #667eea; font-weight: bold; margin-top: 15px; text-align: center; }
        
        .dice-area { display: flex; gap: 20px; justify-content: center; margin-bottom: 10px; align-items: center; }
        .dice { width: 60px; height: 60px; background: white; border: 3px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; } 
        #diceResult { font-weight: bold; font-size: 18px; color: #667eea; min-width: 150px; }
        
        .controls { text-align: center; margin-top: 8px; }
        
        .players-list { list-style: none; }
        .player-item { padding: 12px; margin-bottom: 10px; background: white; border-radius: 6px; border-left: 4px solid; display: flex; align-items: center; gap: 10px; }
        .player-item.active { background: #fffacd; font-weight: bold; }
        .player-color { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #333; }
        .player-info { flex: 1; }
        .player-name { font-weight: bold; }
        .player-money { font-size: 12px; color: #666; }        
        /* Property Card Popup */
        #propertyCard { display: none; position: absolute; background: white; border: 3px solid #333; border-radius: 8px; padding: 15px; width: 280px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 100; font-size: 12px; }
        .card-title { font-weight: bold; font-size: 14px; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid #ccc; }
        .card-price { margin: 5px 0; }
        .card-section { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
        .card-section-title { font-weight: bold; font-size: 11px; margin-bottom: 4px; }
        .rent-table { width: 100%; font-size: 10px; }
        .rent-table tr { border-bottom: 1px solid #f0f0f0; }
        .rent-table td { padding: 3px; }
        .rent-table td:first-child { font-weight: bold; width: 50%; }
        .rent-table td:last-child { text-align: right; }
        
        /* Action Modal */
        #actionModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .action-modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto; }
        .action-modal-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #333; }
        .action-modal-subtitle { font-size: 16px; color: #666; margin-bottom: 20px; }
        .action-field-info { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea; }
        .action-field-header { font-weight: bold; font-size: 18px; margin-bottom: 5px; }
        .action-field-detail { font-size: 14px; color: #666; }
        .action-buttons { display: grid; gap: 10px; margin-top: 20px; }
        .action-btn { padding: 12px 20px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .action-btn.buy { background: #28a745; color: white; }
        .action-btn.buy:hover { background: #218838; transform: translateY(-2px); }
        .action-btn.pay { background: #ff6b6b; color: white; }
        .action-btn.pay:hover { background: #e63946; transform: translateY(-2px); }
        .action-btn.build { background: #ffc107; color: #333; }
        .action-btn.build:hover { background: #ffb300; transform: translateY(-2px); }
        .action-btn.sell { background: #6c757d; color: white; }
        .action-btn.sell:hover { background: #5a6268; transform: translateY(-2px); }
        .action-btn.pass { background: #17a2b8; color: white; }
        .action-btn.pass:hover { background: #138496; transform: translateY(-2px); }
        .action-warning { background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 6px; margin-bottom: 15px; color: #856404; }
        .action-owner-info { background: #e7f3ff; padding: 12px; border-radius: 6px; margin-bottom: 15px; color: #004085; border-left: 4px solid #0056b3; }
        
        /* Log Panel */
        .log-panel { width: 300px; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 2px solid #ddd; max-height: 300px; overflow-y: auto; font-size: 12px; margin-top: 15px; }
        .log-panel h4 { margin-bottom: 10px; color: #333; }
        .log-entry { padding: 8px; margin-bottom: 8px; background: white; border-left: 3px solid #667eea; border-radius: 4px; color: #666; }
        .log-entry.purchase { border-left-color: #28a745; }
        .log-entry.payment { border-left-color: #ff6b6b; }
        .log-entry.trade { border-left-color: #ffc107; }
        .log-entry.info { border-left-color: #17a2b8; }
        
        /* Player Info Popup */
        #playerInfoPopup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .player-info-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto; }
        .player-info-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
        .player-info-color { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #333; }
        .player-info-title { font-size: 24px; font-weight: bold; color: #333; }
        .player-info-subtitle { font-size: 14px; color: #666; }
        .player-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #f5f5f5; padding: 15px; border-radius: 8px; }
        .stat-label { font-size: 12px; color: #999; font-weight: bold; }
        .stat-value { font-size: 20px; font-weight: bold; color: #333; margin-top: 5px; }
        .properties-section { margin-top: 20px; }
        .properties-title { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #333; }
        .properties-list { display: grid; gap: 8px; }
        .property-item { background: #f5f5f5; padding: 10px; border-radius: 6px; border-left: 4px solid #667eea; }
        .property-name { font-weight: bold; color: #333; }
        .property-detail { font-size: 11px; color: #666; margin-top: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≤ Monopoly üé≤</h1>
        
        <div id="start">
            <button onclick="showPlayerSetup()">üéÆ Spiel starten</button>
        </div>

        <div id="playerSetup">
            <div class="setup-container">
                <h2>Spieler hinzuf√ºgen</h2>
                <div class="player-input">
                    <input type="text" id="playerName" placeholder="Spielername">
                    <label>Farbe w√§hlen:</label>
                    <div class="color-picker" id="colorPicker"></div>
                    <button onclick="addPlayer()">Spieler hinzuf√ºgen</button>
                </div>
                
                <h3>Spieler im Spiel:</h3>
                <ul class="players-list" id="setupPlayersList"></ul>
                
                <button onclick="startGameWithPlayers()" style="background: #28a745; margin-top: 20px;">Spiel starten</button>
                <button onclick="goBack()" style="background: #6c757d;">Zur√ºck</button>
            </div>
        </div>

        <div id="game">
            <div class="game-layout">
                <div class="game-board">
                    <div class="dice-area">
                        <div class="dice" id="dice1">‚öÅ</div>
                        <div class="dice" id="dice2">‚öÇ</div>
                        <p id="diceResult"></p>
                    </div>
                    <canvas id="board" width="800" height="800"></canvas>
                    <div id="propertyCard"></div>
                    <div id="actionModal">
                        <div class="action-modal-content" id="actionModalContent"></div>
                    </div>
                    <div id="playerInfoPopup">
                        <div class="player-info-content" id="playerInfoContent"></div>
                    </div>
                    <div id="diceContainer" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 500;">
                        <div style="display: flex; gap: 15px; justify-content: center; align-items: center; background: rgba(255,255,255,0.95); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                            <div id="diceLarge1" style="width: 80px; height: 80px; background: white; border: 3px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 60px; font-weight: bold;">‚öÄ</div>
                            <span style="font-size: 24px; font-weight: bold; color: #333;">+</span>
                            <div id="diceLarge2" style="width: 80px; height: 80px; background: white; border: 3px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 60px; font-weight: bold;">‚öÄ</div>
                            <span style="font-size: 24px; font-weight: bold; color: #333;">=</span>
                            <div id="diceLargeSum" style="width: 80px; height: 80px; background: #667eea; color: white; border: 3px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">0</div>
                        </div>
                    </div>
                    <div class="controls">
                        <button onclick="rollDice()">üé≤ W√ºrfeln</button>
                        <button onclick="openTradeMenuWithPlayers()" id="tradeButtonMain" style="display: none;">ü§ù Handeln</button>
                        <button onclick="endTurn()">‚û°Ô∏è Zug beenden</button>
                    </div>
                    <p id="message">Willkommen!</p>
                </div>
                <div class="players-panel">
                    <h3>Spieler</h3>
                    <ul class="players-list" id="gamePlayersList"></ul>
                    <div class="log-panel">
                        <h4>üìã Spielprotokoll</h4>
                        <div id="gameLog"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="src/board.js"></script>
    <script>
        // Verf√ºgbare Farben
        const availableColors = [
            { hex: '#FF6B6B', name: 'Rot' },
            { hex: '#4ECDC4', name: 'Cyan' },
            { hex: '#FFE66D', name: 'Gelb' },
            { hex: '#95E1D3', name: 'Minze' },
            { hex: '#C7CEEA', name: 'Lila' },
            { hex: '#B5EAD7', name: 'Gr√ºn' }
        ];
        
        let gameActive = false;
        let players = [];
        let currentPlayer = 0;
        let selectedColor = availableColors[0];
        let gameLog = [];
        let diceRolledThisTurn = false;
        let pendingTradeOffers = {}; // { toPlayerIdx: { from: fromIdx, offer: {properties, money}, request: {properties, money} } }
        
        // Color mapping for board
        const colorMap = {
            'brown': '#8B4513',
            'lightblue': '#87CEEB',
            'pink': '#FF69B4',
            'orange': '#FFA500',
            'red': '#FF0000',
            'yellow': '#FFFF00',
            'green': '#00AA00',
            'darkblue': '#0000FF'
        };

        // Initialisiere Farbw√§hler
        function initColorPicker() {
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = '';
            availableColors.forEach((color, idx) => {
                const option = document.createElement('div');
                option.className = 'color-option' + (idx === 0 ? ' selected' : '');
                option.style.backgroundColor = color.hex;
                option.onclick = () => selectColor(color, option);
                picker.appendChild(option);
            });
        }

        function selectColor(color, element) {
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedColor = color;
        }

        function showPlayerSetup() {
            players = [];
            selectedColor = availableColors[0];
            document.getElementById('start').style.display = 'none';
            document.getElementById('playerSetup').style.display = 'block';
            initColorPicker();
            updateSetupList();
        }

        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Bitte Spielernamen eingeben!');
                return;
            }
            
            if (players.some(p => p.name === name)) {
                alert('Spieler mit diesem Namen existiert bereits!');
                return;
            }

            players.push({
                name: name,
                position: 0,
                money: 1500,
                color: selectedColor.hex,
                ownedProperties: []
            });

            nameInput.value = '';
            updateSetupList();
        }

        function updateSetupList() {
            const list = document.getElementById('setupPlayersList');
            list.innerHTML = '';
            players.forEach((player, idx) => {
                const li = document.createElement('li');
                li.className = 'player-item';
                li.style.borderLeftColor = player.color;
                li.innerHTML = `
                    <div class="player-color" style="background-color: ${player.color}"></div>
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                    </div>
                    <button onclick="removePlayer(${idx})" style="padding: 5px 10px; font-size: 12px; background: #dc3545;">L√∂schen</button>
                `;
                list.appendChild(li);
            });
        }

        function removePlayer(idx) {
            players.splice(idx, 1);
            updateSetupList();
        }

        function startGameWithPlayers() {
            if (players.length < 2) {
                alert('Mindestens 2 Spieler erforderlich!');
                return;
            }

            gameActive = true;
            document.getElementById('playerSetup').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            currentPlayer = 0;
            drawBoard();
            updateGameInfo();
            
            // Canvas Hover f√ºr Property Cards
            const canvas = document.getElementById('board');
            canvas.addEventListener('mousemove', handleCanvasHover);
            canvas.addEventListener('mouseleave', hidePropertyCard);
            canvas.addEventListener('click', handleCanvasClick);
        }

        function goBack() {
            document.getElementById('playerSetup').style.display = 'none';
            document.getElementById('start').style.display = 'block';
        }

        function drawBoard() {
            const canvas = document.getElementById('board');
            const ctx = canvas.getContext('2d');
            const size = 800;
            const fieldSize = size / 11;

            ctx.fillStyle = '#2d5016';
            ctx.fillRect(0, 0, size, size);

            // √Ñu√üerer Rahmen (die 40 Felder)
            for (let i = 0; i < 40; i++) {
                let x, y, side;

                if (i < 10) {
                    // Bottom row (unten)
                    x = size - (i + 1) * fieldSize;
                    y = size - fieldSize;
                    side = 'bottom';
                } else if (i < 20) {
                    // Left column (links)
                    x = 0;
                    y = size - (i - 9) * fieldSize;
                    side = 'left';
                } else if (i < 30) {
                    // Top row (oben)
                    x = (i - 20) * fieldSize;
                    y = 0;
                    side = 'top';
                } else {
                    // Right column (rechts)
                    x = size - fieldSize;
                    y = (i - 30) * fieldSize;
                    side = 'right';
                }

                drawField(ctx, x, y, fieldSize, monopolyBoard[i], side);
            }

            // Innenbereich
            ctx.fillStyle = '#1a3d0a';
            ctx.fillRect(fieldSize, fieldSize, size - 2 * fieldSize, size - 2 * fieldSize);
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Monopoly', size / 2, size / 2);

            // Spieler zeichnen
            drawPlayers(ctx, fieldSize, size);
        }

        function drawField(ctx, x, y, size, field, side) {
            // Bestimme Farbe basierend auf Typ
            let fieldColor = '#FFFFFF'; // Default
            
            if (field.type === 'corner') {
                fieldColor = '#FFFFFF';
            } else if (field.type === 'property') {
                fieldColor = colorMap[field.color] || '#FFFFFF';
            } else if (field.type === 'railroad') {
                fieldColor = '#808080';
            } else if (field.type === 'utility') {
                fieldColor = '#FFD700';
            } else if (field.type === 'community') {
                fieldColor = '#FFD700';
            } else if (field.type === 'chance') {
                fieldColor = '#FF8C00';
            } else if (field.type === 'tax') {
                fieldColor = '#FFFFFF';
            }

            // Hintergrund
            ctx.fillStyle = fieldColor;
            ctx.fillRect(x, y, size, size);

            // Rahmen
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, size, size);

            // Text
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const lines = field.name.split('\n');
            const lineHeight = 11;
            const totalHeight = (lines.length - 1) * lineHeight;

            // Unterschiedliche Ausrichtung pro Seite
            if (side === 'bottom') {
                // Unten - Text zeigt nach oben (normal)
                lines.forEach((line, i) => {
                    ctx.fillText(line, x + size / 2, y + size / 2 - totalHeight / 2 + i * lineHeight);
                });
                if (field.price && field.price > 0) {
                    ctx.font = '8px Arial';
                    ctx.fillText(field.price + '‚Ç¨', x + size / 2, y + size / 2 + totalHeight / 2 + 10);
                }
            } else if (side === 'top') {
                // Oben - Text zeigt nach unten (normal)
                lines.forEach((line, i) => {
                    ctx.fillText(line, x + size / 2, y + size / 2 - totalHeight / 2 + i * lineHeight);
                });
                if (field.price && field.price > 0) {
                    ctx.font = '8px Arial';
                    ctx.fillText(field.price + '‚Ç¨', x + size / 2, y + size / 2 + totalHeight / 2 + 10);
                }
            } else if (side === 'left') {
                // Links - Text zeigt nach rechts (90¬∞ CW)
                ctx.save();
                ctx.translate(x + size / 2, y + size / 2);
                ctx.rotate(Math.PI / 2);
                
                lines.forEach((line, i) => {
                    ctx.fillText(line, 0, -totalHeight / 2 + i * lineHeight);
                });
                
                if (field.price && field.price > 0) {
                    ctx.font = '8px Arial';
                    ctx.fillText(field.price + '‚Ç¨', 0, totalHeight / 2 + 10);
                }
                
                ctx.restore();
            } else if (side === 'right') {
                // Rechts - Text zeigt nach links (-90¬∞ CCW)
                ctx.save();
                ctx.translate(x + size / 2, y + size / 2);
                ctx.rotate(-Math.PI / 2);
                
                lines.forEach((line, i) => {
                    ctx.fillText(line, 0, -totalHeight / 2 + i * lineHeight);
                });
                
                if (field.price && field.price > 0) {
                    ctx.font = '8px Arial';
                    ctx.fillText(field.price + '‚Ç¨', 0, totalHeight / 2 + 10);
                }
                
                ctx.restore();
            }
        }

        function drawPlayers(ctx, fieldSize, size) {
            for (let i = 0; i < players.length; i++) {
                const field = players[i].position % 40;
                let posX, posY;

                if (field < 10) {
                    posX = size - (field + 1) * fieldSize + fieldSize / 2;
                    posY = size - fieldSize / 4;
                } else if (field < 20) {
                    posX = fieldSize / 4;
                    posY = size - (field - 9) * fieldSize + fieldSize / 2;
                } else if (field < 30) {
                    posX = (field - 19) * fieldSize + fieldSize / 2;
                    posY = fieldSize / 4;
                } else {
                    posX = size - fieldSize / 4;
                    posY = (field - 29) * fieldSize + fieldSize / 2;
                }

                ctx.fillStyle = players[i].color;
                ctx.beginPath();
                ctx.arc(posX, posY, 12, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        function rollDice() {
            if (diceRolledThisTurn) {
                alert('Du hast bereits gew√ºrfelt! Beende deinen Zug mit "Zug beenden"');
                return;
            }
            
            const die1 = Math.floor(Math.random() * 6) + 1;
            const die2 = Math.floor(Math.random() * 6) + 1;
            const total = die1 + die2;
            
            // W√ºrfel in Mittelpunkt anzeigen
            const diceContainer = document.getElementById('diceContainer');
            document.getElementById('diceLarge1').textContent = getDiceFace(die1);
            document.getElementById('diceLarge2').textContent = getDiceFace(die2);
            document.getElementById('diceLargeSum').textContent = total;
            diceContainer.style.display = 'block';
            
            // Auch in der kleinen Anzeige
            document.getElementById('dice1').textContent = getDiceFace(die1);
            document.getElementById('dice2').textContent = getDiceFace(die2);
            document.getElementById('diceResult').textContent = `Summe: ${total}`;
            
            diceRolledThisTurn = true;
            document.querySelector('button[onclick="rollDice()"]').disabled = true;
            document.getElementById('tradeButtonMain').style.display = 'inline-block';
            
            // Log
            addLog(`${players[currentPlayer].name} w√ºrfelt: ${die1} + ${die2} = ${total}`, 'info');
            
            // Spieler animiert bewegen
            animatePlayerMovement(currentPlayer, total);
        }

        function getDiceFace(num) {
            const faces = ['', '‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
            return faces[num];
        }

        function animatePlayerMovement(playerIndex, steps) {
            const canvas = document.getElementById('board');
            const fieldSize = canvas.width / 11;
            const player = players[playerIndex];
            const startPos = player.position;
            const endPos = (startPos + steps) % 40;
            let currentStep = 0;
            const animationSpeed = 150; // ms pro Feld (kleiner = schneller)
            let currentField = startPos;

            function animate() {
                if (currentStep <= steps) {
                    player.position = (startPos + currentStep) % 40;
                    drawBoard();
                    currentStep++;
                    setTimeout(animate, animationSpeed);
                } else {
                    player.position = endPos;
                    drawBoard();
                    // √ñffne Action Modal nach Zug
                    showActionModal(playerIndex, endPos);
                }
            }
            animate();
        }

        function endTurn() {
            currentPlayer = (currentPlayer + 1) % players.length;
            document.getElementById('dice1').textContent = '‚öÄ';
            document.getElementById('dice2').textContent = '‚öÄ';
            document.getElementById('diceResult').textContent = '';
            document.getElementById('diceContainer').style.display = 'none';
            diceRolledThisTurn = false;
            document.querySelector('button[onclick="rollDice()"]').disabled = false;
            document.getElementById('tradeButtonMain').style.display = 'none';
            addLog(`${players[currentPlayer].name} ist jetzt am Zug!`, 'info');
            updateGameInfo(players[currentPlayer].name + ' ist jetzt am Zug!');
        }

        function updateGameInfo(msg) {
            if (msg) {
                document.getElementById('message').textContent = msg;
            }
            updateGamePlayersList();
        }

        function updateGamePlayersList() {
            const list = document.getElementById('gamePlayersList');
            list.innerHTML = '';
            players.forEach((player, idx) => {
                const li = document.createElement('li');
                li.className = 'player-item' + (idx === currentPlayer ? ' active' : '');
                li.style.borderLeftColor = player.color;
                li.innerHTML = `
                    <div class="player-color" style="background-color: ${player.color}"></div>
                    <div class="player-info" style="flex: 1;">
                        <div class="player-name">${player.name}</div>
                        <div class="player-money">üí∞ ${player.money}‚Ç¨</div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">
                            ${player.ownedProperties.length > 0 ? 
                                'üè† ' + player.ownedProperties.map(i => monopolyBoard[i].name.split('\\n')[0]).join(', ') 
                                : '(keine Immobilien)'}
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function handleCanvasHover(e) {
            const canvas = document.getElementById('board');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const fieldIndex = getFieldAtPosition(x, y);
            
            if (fieldIndex !== -1 && (monopolyBoard[fieldIndex].type === 'property' || monopolyBoard[fieldIndex].type === 'railroad' || monopolyBoard[fieldIndex].type === 'utility')) {
                showPropertyCard(fieldIndex, e.clientX, e.clientY);
            } else {
                hidePropertyCard();
            }
        }

        function getFieldAtPosition(x, y) {
            const size = 800;
            const fieldSize = size / 11;
            
            // Bottom row (0-9)
            if (y >= size - fieldSize && y < size) {
                for (let i = 0; i < 10; i++) {
                    const fieldX = size - (i + 1) * fieldSize;
                    if (x >= fieldX && x < fieldX + fieldSize) return i;
                }
            }
            
            // Left column (11-19)
            if (x >= 0 && x < fieldSize) {
                for (let i = 11; i < 20; i++) {
                    const fieldY = size - (i - 9) * fieldSize;
                    if (y >= fieldY && y < fieldY + fieldSize) return i;
                }
            }
            
            // Top row (21-29)
            if (y >= 0 && y < fieldSize) {
                for (let i = 21; i < 30; i++) {
                    const fieldX = (i - 20) * fieldSize;
                    if (x >= fieldX && x < fieldX + fieldSize) return i;
                }
            }
            
            // Right column (31-39)
            if (x >= size - fieldSize && x < size) {
                for (let i = 31; i < 40; i++) {
                    const fieldY = (i - 30) * fieldSize;
                    if (y >= fieldY && y < fieldY + fieldSize) return i;
                }
            }
            
            return -1;
        }

        function showPropertyCard(fieldIndex, mouseX, mouseY) {
            const field = monopolyBoard[fieldIndex];
            const card = document.getElementById('propertyCard');
            
            let html = `<div class="card-title" style="background-color: ${colorMap[field.color] || '#FFF'}; color: #000; padding: 8px;">
                ${field.name}
            </div>`;
            
            if (field.price > 0) {
                html += `<div class="card-price">üí∞ Kaufpreis: <strong>${field.price}‚Ç¨</strong></div>`;
            }
            if (field.type === 'tax') {
                html += `<div class="card-price">üí∞ Steuer: <strong>${field.price}‚Ç¨</strong></div>`;
            }
            
            if (field.type === 'property') {
                html += `<div class="card-section">
                    <div class="card-section-title">MIETE:</div>
                    <table class="rent-table">
                        <tr><td>Leere Stra√üe:</td><td>${field.rent[0]}‚Ç¨</td></tr>
                        <tr><td>1 Haus:</td><td>${field.rent[1]}‚Ç¨</td></tr>
                        <tr><td>2 H√§user:</td><td>${field.rent[2]}‚Ç¨</td></tr>
                        <tr><td>3 H√§user:</td><td>${field.rent[3]}‚Ç¨</td></tr>
                        <tr><td>4 H√§user:</td><td>${field.rent[4]}‚Ç¨</td></tr>
                        <tr><td>Volle Stra√üe (Hotel):</td><td>${field.rent[5]}‚Ç¨</td></tr>
                    </table>
                </div>`;
                
                html += `<div class="card-section">
                    <div class="card-section-title">KOSTEN:</div>
                    <table class="rent-table">
                        <tr><td>Ein Haus:</td><td>${field.price / 2}‚Ç¨</td></tr>
                        <tr><td>Ein Hotel:</td><td>${field.price / 2}‚Ç¨</td></tr>
                        <tr><td>Hypothek:</td><td>${field.price / 2}‚Ç¨</td></tr>
                    </table>
                </div>`;
            } else if (field.type === 'railroad') {
                html += `<div class="card-section">
                    <div class="card-section-title">MIETE:</div>
                    <table class="rent-table">
                        <tr><td>1 Bahnhof:</td><td>25‚Ç¨</td></tr>
                        <tr><td>2 Bahnh√∂fe:</td><td>50‚Ç¨</td></tr>
                        <tr><td>3 Bahnh√∂fe:</td><td>100‚Ç¨</td></tr>
                        <tr><td>4 Bahnh√∂fe:</td><td>200‚Ç¨</td></tr>
                    </table>
                </div>`;
            } else if (field.type === 'utility') {
                html += `<div class="card-section">
                    <div class="card-section-title">MIETE:</div>
                    <table class="rent-table">
                        <tr><td>1 Werk:</td><td>W√ºrfel √ó 4</td></tr>
                        <tr><td>2 Werke:</td><td>W√ºrfel √ó 10</td></tr>
                    </table>
                </div>`;
            }
            
            card.innerHTML = html;
            card.style.display = 'block';
            card.style.left = Math.min(mouseX + 10, window.innerWidth - 300) + 'px';
            card.style.top = (mouseY + 10) + 'px';
        }

        function hidePropertyCard() {
            document.getElementById('propertyCard').style.display = 'none';
        }

        // ==================== SPIELMECHANIK ====================
        
        function showActionModal(playerIndex, fieldIndex) {
            const player = players[playerIndex];
            // FIX: Stelle sicher dass fieldIndex mit aktueller Position synchronisiert ist
            const actualFieldIndex = players[playerIndex].position % 40;
            fieldIndex = actualFieldIndex;
            const field = monopolyBoard[fieldIndex];
            const modal = document.getElementById('actionModal');
            const content = document.getElementById('actionModalContent');
            
            let html = `
                <div class="action-modal-title">${player.name}'s Zug</div>
                <div class="action-modal-subtitle">Feld: ${field.name}</div>
                <div class="action-field-info">
                    <div class="action-field-header">${field.name}</div>
                    <div class="action-field-detail">Feldtyp: ${getFieldTypeName(field.type)}</div>
            `;
            
            if (field.type === 'property' || field.type === 'railroad' || field.type === 'utility') {
                const owner = getFieldOwner(fieldIndex);
                if (owner === null) {
                    // Nicht gekauft
                    html += `<div class="action-field-detail" style="margin-top: 10px; font-weight: bold; color: #28a745;">Kaufbar - ${field.price}‚Ç¨</div>`;
                } else if (owner === playerIndex) {
                    // Eigentum des Spielers
                    html += `<div class="action-field-detail" style="margin-top: 10px; font-weight: bold; color: #007bff;">Dein Eigentum</div>`;
                } else {
                    // Geh√∂rt jemand anderem
                    html += `<div class="action-field-detail" style="margin-top: 10px; font-weight: bold; color: #ff6b6b;">Geh√∂rt ${players[owner].name}</div>`;
                }
            }
            
            html += `</div>`;
            
            // Verschiedene Aktionen je nach Feldtyp
            if (field.type === 'corner') {
                html += getCornerFieldActions(fieldIndex);
            } else if (field.type === 'property' || field.type === 'railroad' || field.type === 'utility') {
                html += getPropertyActions(playerIndex, fieldIndex);
            } else if (field.type === 'tax') {
                html += getTaxActions(playerIndex, fieldIndex);
            } else if (field.type === 'chance' || field.type === 'community') {
                html += getChanceActions(playerIndex, fieldIndex);
            } else {
                html += `<div class="action-buttons">
                    <button class="action-btn pass" onclick="closeActionModal()">Weiter</button>
                </div>`;
            }
            
            content.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function getFieldTypeName(type) {
            const names = {
                'property': 'Stra√üe',
                'railroad': 'Bahnhof',
                'utility': 'Werk',
                'corner': 'Spezialfeld',
                'tax': 'Steuer',
                'chance': 'Ereignis',
                'community': 'Gemeinschaftsfeld'
            };
            return names[type] || type;
        }
        
        function getFieldOwner(fieldIndex) {
            for (let i = 0; i < players.length; i++) {
                if (players[i].ownedProperties.includes(fieldIndex)) {
                    return i;
                }
            }
            return null;
        }
        
        function getCornerFieldActions(fieldIndex) {
            const field = monopolyBoard[fieldIndex];
            let html = `<div class="action-warning">${field.name}</div>`;
            html += `<div class="action-buttons">
                <button class="action-btn pass" onclick="closeActionModal()">Weiter</button>
            </div>`;
            return html;
        }
        
        function getPropertyActions(playerIndex, fieldIndex) {
            const field = monopolyBoard[fieldIndex];
            const owner = getFieldOwner(fieldIndex);
            const player = players[playerIndex];
            let html = `<div class="action-buttons">`;
            
            if (owner === null) {
                // Feld ist zu verkaufen
                if (player.money >= field.price) {
                    html += `<button class="action-btn buy" onclick="buyProperty(${playerIndex}, ${fieldIndex})">
                        üè† Kaufen (${field.price}‚Ç¨)
                    </button>`;
                } else {
                    html += `<div class="action-warning">‚ùå Zu wenig Geld zum Kaufen (du hast ${player.money}‚Ç¨, brauchst ${field.price}‚Ç¨)</div>`;
                }
            } else if (owner === playerIndex) {
                // Eigentum des Spielers
                html += `<button class="action-btn build" onclick="openBuildingMenu(${playerIndex}, ${fieldIndex})">
                    üèóÔ∏è Bauen / Info anzeigen
                </button>`;
                html += `<button class="action-btn sell" onclick="openSellMenu(${playerIndex}, ${fieldIndex})">
                    üí∞ Hypothek
                </button>`;
            } else {
                // Geh√∂rt jemand anderem - Miete zahlen
                const rentAmount = calculateRent(fieldIndex, owner);
                if (player.money >= rentAmount) {
                    html += `<div class="action-owner-info">üí≥ Miete an ${players[owner].name}: <strong>${rentAmount}‚Ç¨</strong></div>`;
                    html += `<button class="action-btn pay" onclick="payRent(${playerIndex}, ${owner}, ${rentAmount}, ${fieldIndex})">
                        üí∏ Miete zahlen
                    </button>`;
                } else {
                    html += `<div class="action-warning">‚ö†Ô∏è Nicht genug Geld f√ºr Miete! (${rentAmount}‚Ç¨ erforderlich, du hast ${player.money}‚Ç¨)</div>`;
                    html += `<button class="action-btn sell" onclick="openSellMenuForDebt(${playerIndex}, ${owner}, ${rentAmount})">
                        üîÑ Eigentum verkaufen
                    </button>`;
                }
                html += `<button class="action-btn build" onclick="openTradeBuilder(${playerIndex}, ${owner})">
                    ü§ù Mit ${players[owner].name} handeln
                </button>`;
            }
            
            html += `<button class="action-btn pass" onclick="closeActionModal()">Abbrechen</button>`;
            html += `</div>`;
            return html;
        }
        
        function getTaxActions(playerIndex, fieldIndex) {
            const field = monopolyBoard[fieldIndex];
            const player = players[playerIndex];
            const taxAmount = field.price;
            let html = `<div class="action-warning">üí∞ Du musst ${taxAmount}‚Ç¨ Steuer zahlen!</div>`;
            html += `<div class="action-buttons">`;
            
            if (player.money >= taxAmount) {
                html += `<button class="action-btn pay" onclick="payTax(${playerIndex}, ${taxAmount})">
                    üí∏ Steuer bezahlen (${taxAmount}‚Ç¨)
                </button>`;
            } else {
                html += `<div class="action-warning">‚ùå Nicht genug Geld! (du hast ${player.money}‚Ç¨)</div>`;
            }
            
            html += `</div>`;
            return html;
        }
        
        function getChanceActions(playerIndex, fieldIndex) {
            const field = monopolyBoard[fieldIndex];
            let html = `<div class="action-warning">üé≤ ${field.name}</div>`;
            html += `<div class="action-buttons">
                <button class="action-btn pass" onclick="closeActionModal()">Weiter</button>
            </div>`;
            return html;
        }
        
        function calculateRent(fieldIndex, ownerIndex) {
            const field = monopolyBoard[fieldIndex];
            
            if (field.type === 'property') {
                // F√ºr Stra√üen: zuerst einfacher Mietpreis
                return field.rent[0];
            } else if (field.type === 'railroad' || field.type === 'utility') {
                // Vereinfachte Berechnung
                return field.type === 'railroad' ? 25 : 10;
            }
            
            return 0;
        }
        
        function buyProperty(playerIndex, fieldIndex) {
            const player = players[playerIndex];
            const field = monopolyBoard[fieldIndex];
            
            player.money -= field.price;
            player.ownedProperties.push(fieldIndex);
            
            addLog(`${player.name} kauft ${field.name} f√ºr ${field.price}‚Ç¨`, 'purchase');
            updateGameInfo(`${player.name} hat ${field.name} f√ºr ${field.price}‚Ç¨ gekauft!`);
            closeActionModal();
        }
        
        function payRent(playerIndex, ownerIndex, amount, fieldIndex) {
            const player = players[playerIndex];
            const owner = players[ownerIndex];
            
            player.money -= amount;
            owner.money += amount;
            
            addLog(`${player.name} zahlt ${amount}‚Ç¨ Miete an ${owner.name}`, 'payment');
            updateGameInfo(`${player.name} zahlt ${amount}‚Ç¨ Miete an ${owner.name}!`);
            closeActionModal();
        }
        
        function payTax(playerIndex, amount) {
            const player = players[playerIndex];
            player.money -= amount;
            
            addLog(`${player.name} zahlt ${amount}‚Ç¨ Steuer`, 'payment');
            updateGameInfo(`${player.name} hat ${amount}‚Ç¨ Steuer gezahlt!`);
            closeActionModal();
        }
        
        function openBuildingMenu(playerIndex, fieldIndex) {
            const field = monopolyBoard[fieldIndex];
            const player = players[playerIndex];
            const modal = document.getElementById('actionModal');
            const content = document.getElementById('actionModalContent');
            
            let html = `
                <div class="action-modal-title">üèóÔ∏è ${field.name}</div>
                <div class="action-field-info">
                    <div class="action-field-header">Eigenschaft: ${player.name}</div>
                    <div class="action-field-detail">Kaufpreis: ${field.price}‚Ç¨</div>
                    <div class="action-field-detail">Hauskosten: ${field.price / 2}‚Ç¨</div>
                    <div class="action-field-detail">Hotelkosten: ${field.price / 2}‚Ç¨</div>
                    <div class="action-field-detail" style="margin-top: 10px;">
                        <strong>Mietskala:</strong>
                        <table class="rent-table" style="margin-top: 8px;">
                            <tr><td>Leer:</td><td>${field.rent[0]}‚Ç¨</td></tr>
                            <tr><td>1H:</td><td>${field.rent[1]}‚Ç¨</td></tr>
                            <tr><td>2H:</td><td>${field.rent[2]}‚Ç¨</td></tr>
                            <tr><td>3H:</td><td>${field.rent[3]}‚Ç¨</td></tr>
                            <tr><td>4H:</td><td>${field.rent[4]}‚Ç¨</td></tr>
                            <tr><td>Hotel:</td><td>${field.rent[5]}‚Ç¨</td></tr>
                        </table>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn pass" onclick="showActionModal(${playerIndex}, ${fieldIndex})">Zur√ºck</button>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        function openSellMenu(playerIndex, fieldIndex) {
            const field = monopolyBoard[fieldIndex];
            const mortgageValue = field.price / 2;
            const player = players[playerIndex];
            const modal = document.getElementById('actionModal');
            const content = document.getElementById('actionModalContent');
            
            let html = `
                <div class="action-modal-title">üí∞ Hypothek</div>
                <div class="action-field-info">
                    <div class="action-field-header">${field.name}</div>
                    <div class="action-field-detail">Hypothekwert: ${mortgageValue}‚Ç¨</div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn sell" onclick="mortgageProperty(${playerIndex}, ${fieldIndex})">
                        üí∏ Hypothek aufnehmen (${mortgageValue}‚Ç¨)
                    </button>
                    <button class="action-btn pass" onclick="showActionModal(${playerIndex}, ${fieldIndex})">Zur√ºck</button>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        function openSellMenuForDebt(playerIndex, debtorIndex, amount) {
            const player = players[playerIndex];
            const modal = document.getElementById('actionModal');
            const content = document.getElementById('actionModalContent');
            
            let html = `
                <div class="action-modal-title">üí∞ Schuldenabbau</div>
                <div class="action-warning">Du schuldest ${players[debtorIndex].name} ${amount}‚Ç¨</div>
                <div class="action-field-info">
                    <div class="action-field-header">Deine Immobilien:</div>
            `;
            
            if (player.ownedProperties.length === 0) {
                html += `<div class="action-field-detail">‚ùå Du hast keine Immobilien zu verkaufen!</div>`;
            } else {
                player.ownedProperties.forEach((propIdx, i) => {
                    const prop = monopolyBoard[propIdx];
                    const mortgageValue = prop.price / 2;
                    html += `
                        <div style="padding: 10px; background: #f5f5f5; margin: 5px 0; border-radius: 4px; cursor: pointer; border: 1px solid #ddd;">
                            <div style="font-weight: bold;">${prop.name}</div>
                            <div style="font-size: 12px; color: #666;">Hypothek: ${mortgageValue}‚Ç¨</div>
                            <button class="action-btn sell" onclick="mortgageProperty(${playerIndex}, ${propIdx})" style="width: 100%; margin-top: 8px;">Hypothek aufnehmen</button>
                        </div>
                    `;
                });
            }
            
            html += `
                </div>
                <div class="action-buttons">
                    <button class="action-btn pass" onclick="closeActionModal()">Abbrechen</button>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        function mortgageProperty(playerIndex, fieldIndex) {
            const field = monopolyBoard[fieldIndex];
            const player = players[playerIndex];
            const mortgageValue = field.price / 2;
            
            player.money += mortgageValue;
            const propIdx = player.ownedProperties.indexOf(fieldIndex);
            if (propIdx > -1) {
                player.ownedProperties.splice(propIdx, 1);
            }
            
            addLog(`${player.name} nimmt Hypothek auf ${field.name} auf (+${mortgageValue}‚Ç¨)`, 'info');
            updateGameInfo(`${player.name} nahm eine Hypothek auf ${field.name} auf (+${mortgageValue}‚Ç¨)`);
            closeActionModal();
        }
        
        function closeActionModal() {
            document.getElementById('actionModal').style.display = 'none';
            updateGamePlayersList();
            drawBoard();
        }
        
        // ==================== LOG SYSTEM ====================
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            gameLog.unshift({ message, type, timestamp });
            if (gameLog.length > 20) gameLog.pop();
            updateGameLog();
        }
        
        function updateGameLog() {
            const logDiv = document.getElementById('gameLog');
            logDiv.innerHTML = gameLog.map((entry, idx) => `
                <div class="log-entry ${entry.type}">
                    <span style="font-size: 10px; color: #999;">${entry.timestamp}</span> ${entry.message}
                </div>
            `).join('');
            logDiv.scrollTop = 0;
        }
        
        // ==================== SPIELER-KLICK ====================
        
        function handleCanvasClick(e) {
            const canvas = document.getElementById('board');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const playerIdx = getPlayerAtPosition(x, y);
            if (playerIdx !== -1) {
                showPlayerInfo(playerIdx);
            }
        }
        
        function getPlayerAtPosition(x, y) {
            const canvas = document.getElementById('board');
            const fieldSize = canvas.width / 11;
            
            for (let i = 0; i < players.length; i++) {
                const field = players[i].position % 40;
                let posX, posY;

                if (field < 10) {
                    posX = canvas.width - (field + 1) * fieldSize + fieldSize / 2;
                    posY = canvas.height - fieldSize / 4;
                } else if (field < 20) {
                    posX = fieldSize / 4;
                    posY = canvas.height - (field - 9) * fieldSize + fieldSize / 2;
                } else if (field < 30) {
                    posX = (field - 19) * fieldSize + fieldSize / 2;
                    posY = fieldSize / 4;
                } else {
                    posX = canvas.width - fieldSize / 4;
                    posY = (field - 29) * fieldSize + fieldSize / 2;
                }
                
                const distance = Math.sqrt((x - posX) ** 2 + (y - posY) ** 2);
                if (distance < 20) return i;
            }
            return -1;
        }
        
        function showPlayerInfo(playerIdx) {
            const player = players[playerIdx];
            const modal = document.getElementById('playerInfoPopup');
            const content = document.getElementById('playerInfoContent');
            
            let html = `
                <div class="player-info-header">
                    <div class="player-info-color" style="background-color: ${player.color}"></div>
                    <div>
                        <div class="player-info-title">${player.name}</div>
                        <div class="player-info-subtitle">Feld: ${monopolyBoard[player.position % 40].name}</div>
                    </div>
                </div>
                
                <div class="player-stats">
                    <div class="stat-box">
                        <div class="stat-label">Geld</div>
                        <div class="stat-value">${player.money}‚Ç¨</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Immobilien</div>
                        <div class="stat-value">${player.ownedProperties.length}</div>
                    </div>
                </div>
                
                <div class="properties-section">
                    <div class="properties-title">üè† Besitzt√ºmer:</div>
            `;
            
            if (player.ownedProperties.length === 0) {
                html += `<div style="color: #999; padding: 10px;">Keine Immobilien</div>`;
            } else {
                html += `<div class="properties-list">`;
                player.ownedProperties.forEach(propIdx => {
                    const prop = monopolyBoard[propIdx];
                    html += `
                        <div class="property-item">
                            <div class="property-name" style="color: ${colorMap[prop.color] ? colorMap[prop.color] : '#333'}; padding: 3px 8px; background: ${colorMap[prop.color] ? colorMap[prop.color] : '#f5f5f5'}; border-radius: 3px; display: inline-block; color: white;">
                                ${prop.name}
                            </div>
                            <div class="property-detail">Wert: ${prop.price}‚Ç¨</div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            html += `
                </div>
                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="action-btn pass" onclick="closePlayerInfo()">Schlie√üen</button>
                </div>
            `;
            
            content.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function closePlayerInfo() {
            document.getElementById('playerInfoPopup').style.display = 'none';
        }
        
        // ==================== HANDELS-SYSTEM ====================
        
        function openTradeMenuWithPlayers() {
            const player = players[currentPlayer];
            const modal = document.getElementById('actionModal');
            const content = document.getElementById('actionModalContent');
            
            let html = `
                <div class="action-modal-title">ü§ù Handel</div>
                <div class="action-modal-subtitle">${player.name} sucht einen Handelspartner...</div>
                <div class="action-buttons" style="max-height: 400px; overflow-y: auto;">
            `;
            
            players.forEach((p, idx) => {
                if (idx !== currentPlayer) {
                    html += `
                        <button class="action-btn build" onclick="openTradeBuilder(${currentPlayer}, ${idx})" style="text-align: left;">
                            <div style="font-weight: bold;">${p.name}</div>
                            <div style="font-size: 11px; margin-top: 3px;">üí∞ ${p.money}‚Ç¨ | üè† ${p.ownedProperties.length} Immobilien</div>
                        </button>
                    `;
                }
            });
            
            html += `
                    <button class="action-btn pass" onclick="closeActionModal()">Abbrechen</button>
                </div>
            `;
            
            content.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function openTradeBuilder(fromIdx, toIdx) {
            const fromPlayer = players[fromIdx];
            const toPlayer = players[toIdx];
            const modal = document.getElementById('actionModal');
            const content = document.getElementById('actionModalContent');
            
            let html = `
                <div class="action-modal-title">ü§ù Handelsangebot an ${toPlayer.name}</div>
                <div class="action-modal-subtitle">${fromPlayer.name} bietet an:</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border: 2px solid #2196F3;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #1565c0;">Was ${fromPlayer.name} bietet:</div>
                        <div id="tradeOfferDisplay" style="min-height: 100px; background: white; padding: 10px; border-radius: 4px; color: #666; font-size: 12px;">
                            <em>Nichts gew√§hlt</em>
                        </div>
                        <div style="font-weight: bold; margin-top: 10px; margin-bottom: 8px; color: #1565c0; font-size: 12px;">Zu bieten:</div>
                        <div style="display: grid; gap: 6px;">
            `;
            
            if (fromPlayer.ownedProperties.length === 0) {
                html += `<div style="color: #999; font-size: 11px;">Keine Immobilien</div>`;
            } else {
                fromPlayer.ownedProperties.forEach(propIdx => {
                    const prop = monopolyBoard[propIdx];
                    html += `
                        <button class="action-btn" style="background: white; color: #333; border: 2px solid ${colorMap[prop.color] || '#ccc'}; text-align: left; padding: 8px;" onclick="toggleTradeItem(${fromIdx}, ${propIdx}, 'offer', '${fromPlayer.name}', '${toPlayer.name}')">
                            <div style="font-weight: bold;">${prop.name}</div>
                            <div style="font-size: 10px; color: #666;">${prop.price}‚Ç¨</div>
                        </button>
                    `;
                });
            }
            
            html += `
                        </div>
                    </div>
                    
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; border: 2px solid #9c27b0;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #6a1b9a;">Was ${toPlayer.name} bietet:</div>
                        <div id="tradeRequestDisplay" style="min-height: 100px; background: white; padding: 10px; border-radius: 4px; color: #666; font-size: 12px;">
                            <em>Nichts gew√§hlt</em>
                        </div>
                        <div style="font-weight: bold; margin-top: 10px; margin-bottom: 8px; color: #6a1b9a; font-size: 12px;">Zur Verf√ºgung stehen:</div>
                        <div style="display: grid; gap: 6px;">
            `;
            
            if (toPlayer.ownedProperties.length === 0) {
                html += `<div style="color: #999; font-size: 11px;">Keine Immobilien</div>`;
            } else {
                toPlayer.ownedProperties.forEach(propIdx => {
                    const prop = monopolyBoard[propIdx];
                    html += `
                        <button class="action-btn" style="background: white; color: #333; border: 2px solid ${colorMap[prop.color] || '#ccc'}; text-align: left; padding: 8px;" onclick="toggleTradeItem(${toIdx}, ${propIdx}, 'request', '${fromPlayer.name}', '${toPlayer.name}')">
                            <div style="font-weight: bold;">${prop.name}</div>
                            <div style="font-size: 10px; color: #666;">${prop.price}‚Ç¨</div>
                        </button>
                    `;
                });
            }
            
            html += `
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn build" onclick="sendTradeOffer(${fromIdx}, ${toIdx})">
                        ‚úâÔ∏è Angebot senden
                    </button>
                    <button class="action-btn pass" onclick="openTradeMenuWithPlayers()">Zur√ºck</button>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        let currentTradeBuilder = { offer: { properties: [] }, request: { properties: [] } };
        
        function toggleTradeItem(playerIdx, propIdx, direction, fromName, toName) {
            if (direction === 'offer') {
                const idx = currentTradeBuilder.offer.properties.indexOf(propIdx);
                if (idx > -1) {
                    currentTradeBuilder.offer.properties.splice(idx, 1);
                } else {
                    currentTradeBuilder.offer.properties.push(propIdx);
                }
            } else {
                const idx = currentTradeBuilder.request.properties.indexOf(propIdx);
                if (idx > -1) {
                    currentTradeBuilder.request.properties.splice(idx, 1);
                } else {
                    currentTradeBuilder.request.properties.push(propIdx);
                }
            }
            updateTradeBuilderDisplay(fromName, toName);
        }
        
        function updateTradeBuilderDisplay(fromName, toName) {
            const offerDisplay = document.getElementById('tradeOfferDisplay');
            const requestDisplay = document.getElementById('tradeRequestDisplay');
            
            if (currentTradeBuilder.offer.properties.length === 0) {
                offerDisplay.innerHTML = '<em>Nichts gew√§hlt</em>';
            } else {
                offerDisplay.innerHTML = currentTradeBuilder.offer.properties.map(p => 
                    `<div style="background: #f5f5f5; padding: 6px; border-radius: 3px; margin: 3px 0;">‚úì ${monopolyBoard[p].name}</div>`
                ).join('');
            }
            
            if (currentTradeBuilder.request.properties.length === 0) {
                requestDisplay.innerHTML = '<em>Nichts gew√§hlt</em>';
            } else {
                requestDisplay.innerHTML = currentTradeBuilder.request.properties.map(p => 
                    `<div style="background: #f5f5f5; padding: 6px; border-radius: 3px; margin: 3px 0;">‚úì ${monopolyBoard[p].name}</div>`
                ).join('');
            }
        }
        
        function sendTradeOffer(fromIdx, toIdx) {
            if (currentTradeBuilder.offer.properties.length === 0 && currentTradeBuilder.request.properties.length === 0) {
                alert('W√§hle mindestens eine Immobilie aus!');
                return;
            }
            
            // Speichere das Angebot f√ºr den anderen Spieler
            pendingTradeOffers[toIdx] = {
                from: fromIdx,
                offer: { properties: [...currentTradeBuilder.offer.properties] },
                request: { properties: [...currentTradeBuilder.request.properties] }
            };
            
            addLog(`${players[fromIdx].name} sendet Handelsangebot an ${players[toIdx].name}`, 'trade');
            
            currentTradeBuilder = { offer: { properties: [] }, request: { properties: [] } };
            
            // Zeige sofort das Antwort-Modal f√ºr Spieler 2 an
            showTradeOfferResponseModal(toIdx);
        }
        
        function showTradeOfferResponseModal(toIdx) {
            if (!pendingTradeOffers[toIdx]) return;
            
            const offer = pendingTradeOffers[toIdx];
            const fromPlayer = players[offer.from];
            const toPlayer = players[toIdx];
            const modal = document.getElementById('actionModal');
            const content = document.getElementById('actionModalContent');
            
            let html = `
                <div class="action-modal-title" style="color: #d32f2f;">üì¨ Handelsangebot von ${fromPlayer.name}!</div>
                <div class="action-modal-subtitle">${toPlayer.name}, was sagst du dazu?</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #1565c0;">${fromPlayer.name} bietet:</div>
                        <div style="background: white; padding: 10px; border-radius: 4px;">
            `;
            
            if (offer.offer.properties.length === 0) {
                html += `<em style="color: #999;">Nichts</em>`;
            } else {
                html += offer.offer.properties.map(p => 
                    `<div style="padding: 8px; background: #f5f5f5; margin: 5px 0; border-radius: 3px;">‚úì ${monopolyBoard[p].name}</div>`
                ).join('');
            }
            
            html += `
                        </div>
                    </div>
                    
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #6a1b9a;">Du gibst daf√ºr:</div>
                        <div style="background: white; padding: 10px; border-radius: 4px;">
            `;
            
            if (offer.request.properties.length === 0) {
                html += `<em style="color: #999;">Nichts</em>`;
            } else {
                html += offer.request.properties.map(p => 
                    `<div style="padding: 8px; background: #f5f5f5; margin: 5px 0; border-radius: 3px;">‚úì ${monopolyBoard[p].name}</div>`
                ).join('');
            }
            
            html += `
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn buy" onclick="acceptTradeOffer(${toIdx})">
                        ‚úÖ Akzeptieren
                    </button>
                    <button class="action-btn sell" onclick="rejectTradeOffer(${toIdx})">
                        ‚ùå Ablehnen
                    </button>
                </div>
            `;
            
            content.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function acceptTradeOffer(toIdx) {
            const offer = pendingTradeOffers[toIdx];
            const fromPlayer = players[offer.from];
            const toPlayer = players[toIdx];
            
            // F√ºhre den Handel aus
            offer.offer.properties.forEach(propIdx => {
                const idx = fromPlayer.ownedProperties.indexOf(propIdx);
                if (idx > -1) {
                    fromPlayer.ownedProperties.splice(idx, 1);
                    toPlayer.ownedProperties.push(propIdx);
                }
            });
            
            offer.request.properties.forEach(propIdx => {
                const idx = toPlayer.ownedProperties.indexOf(propIdx);
                if (idx > -1) {
                    toPlayer.ownedProperties.splice(idx, 1);
                    fromPlayer.ownedProperties.push(propIdx);
                }
            });
            
            addLog(`${fromPlayer.name} und ${toPlayer.name} einigen sich auf einen Handel`, 'trade');
            delete pendingTradeOffers[toIdx];
            
            updateGamePlayersList();
            drawBoard();
            showTradeResultModal(toIdx, 'accepted');
        }
        
        function rejectTradeOffer(toIdx) {
            const offer = pendingTradeOffers[toIdx];
            addLog(`${players[toIdx].name} lehnt Handelsangebot ab`, 'trade');
            delete pendingTradeOffers[toIdx];
            showTradeResultModal(toIdx, 'rejected');
        }
        
        function showTradeResultModal(toIdx, result) {
            const modal = document.getElementById('actionModal');
            const content = document.getElementById('actionModalContent');
            const fromPlayer = players[currentPlayer]; // Der Spieler der das Angebot gemacht hat
            const toPlayer = players[toIdx];
            
            let html = '';
            if (result === 'accepted') {
                html = `
                    <div class="action-modal-title" style="color: #28a745;">‚úÖ Handel akzeptiert!</div>
                    <div class="action-modal-subtitle">${toPlayer.name} hat zugestimmt</div>
                    <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;">
                        <div style="font-size: 14px; color: #155724;">Der Handel wurde erfolgreich durchgef√ºhrt!</div>
                    </div>
                `;
            } else {
                html = `
                    <div class="action-modal-title" style="color: #dc3545;">‚ùå Handel abgelehnt</div>
                    <div class="action-modal-subtitle">${toPlayer.name} hat abgelehnt</div>
                    <div style="background: #f8d7da; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;">
                        <div style="font-size: 14px; color: #721c24;">Das Angebot wurde nicht akzeptiert</div>
                    </div>
                `;
            }
            
            html += `
                <div class="action-buttons">
                    <button class="action-btn pass" onclick="closeActionModal()">
                        üëâ Weiter zu deinem Zug
                    </button>
                </div>
            `;
            
            content.innerHTML = html;
            modal.style.display = 'block';
        }
        function makeCounterOffer(toIdx) {
            alert('Gegenangebot-Funktionalit√§t kommt bald! F√ºr jetzt: Ablehnen und selbst ein Angebot machen.');
        }
    </script>
</body>
</html>